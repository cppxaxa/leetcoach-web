<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dry Run REPL</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            height: 100vh;
            overflow: hidden;
            background: #1e1e1e;
            color: #d4d4d4;
        }

        .container {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        .tabs {
            display: flex;
            background: #2d2d30;
            border-bottom: 1px solid #3e3e42;
            justify-content: space-between;
            align-items: center;
        }

        .tabs-left {
            display: flex;
        }

        .tabs-right {
            display: flex;
            padding-right: 8px;
        }

        .tab {
            padding: 6px 16px;
            cursor: pointer;
            background: #2d2d30;
            border: none;
            color: #969696;
            font-size: 12px;
            transition: all 0.2s;
            border-bottom: 2px solid transparent;
        }

        .tab:hover {
            color: #d4d4d4;
            background: #37373d;
        }

        .tab.active {
            color: #ffffff;
            border-bottom-color: #007acc;
        }

        .persist-btn {
            padding: 6px 16px;
            background: #007acc;
            border: none;
            color: #ffffff;
            font-size: 12px;
            cursor: pointer;
            border-radius: 3px;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: background 0.2s;
        }

        .persist-btn:hover {
            background: #005a9e;
        }

        .persist-btn svg {
            width: 14px;
            height: 14px;
        }

        .content {
            flex: 1;
            position: relative;
            overflow: hidden;
        }

        #editor-container {
            width: 100%;
            height: 100%;
        }

        #render-container {
            width: 100%;
            height: 100%;
            background: white;
            display: none;
        }

        #render-frame {
            width: 100%;
            height: 100%;
            border: none;
        }

        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            font-size: 16px;
            color: #969696;
        }

        /* Modal Styles */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: #252526;
            border-radius: 0;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            box-shadow: 0 4px 24px rgba(0, 0, 0, 0.5);
            display: flex;
            flex-direction: column;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 24px 24px 20px 24px;
            background: #252526;
            position: sticky;
            top: 0;
            z-index: 10;
            border-bottom: 1px solid #3e3e42;
        }

        .modal-header h2 {
            margin: 0;
            color: #ffffff;
            font-size: 18px;
        }

        .modal-close {
            background: none;
            border: none;
            color: #969696;
            font-size: 24px;
            cursor: pointer;
            padding: 0;
            width: 24px;
            height: 24px;
            line-height: 24px;
        }

        .modal-close:hover {
            color: #ffffff;
        }

        .modal-content {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
        }

        .checklist {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .checklist-item {
            background: #1e1e1e;
            border: 1px solid #3e3e42;
            border-radius: 4px;
            padding: 16px;
        }

        .checklist-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .checklist-item-title {
            font-weight: 600;
            color: #d4d4d4;
            font-size: 14px;
        }

        .checklist-status {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 12px;
            padding: 4px 8px;
            border-radius: 3px;
        }

        .checklist-status.ok {
            background: #1e4620;
            color: #73c991;
        }

        .checklist-status.error {
            background: #5a1d1d;
            color: #f48771;
        }

        .checklist-status.pending {
            background: #4d4d00;
            color: #f9f586;
        }

        .checklist-item-content {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .checklist-item input {
            width: 100%;
            padding: 8px;
            background: #3c3c3c;
            border: 1px solid #3e3e42;
            border-radius: 3px;
            color: #d4d4d4;
            font-size: 13px;
        }

        .checklist-item input:focus {
            outline: none;
            border-color: #007acc;
        }

        .checklist-item button {
            padding: 8px 16px;
            background: #007acc;
            border: none;
            color: #ffffff;
            border-radius: 3px;
            cursor: pointer;
            font-size: 13px;
            align-self: flex-start;
        }

        .checklist-item button:hover {
            background: #005a9e;
        }

        .checklist-item button:disabled {
            background: #3e3e42;
            color: #969696;
            cursor: not-allowed;
        }

        .user-info-compact {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #d4d4d4;
            font-size: 13px;
        }

        .user-info-compact img {
            width: 24px;
            height: 24px;
            border-radius: 50%;
        }

        .repo-link {
            color: #4fc3f7;
            text-decoration: none;
            font-size: 13px;
            word-break: break-all;
        }

        .repo-link:hover {
            text-decoration: underline;
        }

        .readonly-text {
            color: #969696;
            font-size: 13px;
            padding: 8px;
            background: #2d2d30;
            border: 1px solid #3e3e42;
            border-radius: 3px;
        }

        .modal-footer {
            margin-top: 0;
            padding: 16px 24px;
            border-top: 1px solid #3e3e42;
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            background: #252526;
            position: sticky;
            bottom: 0;
        }

        .modal-footer button {
            padding: 8px 16px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 13px;
        }

        .btn-primary {
            background: #007acc;
            color: #ffffff;
        }

        .btn-primary:hover {
            background: #005a9e;
        }

        .btn-primary:disabled {
            background: #3e3e42;
            color: #969696;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: #3e3e42;
            color: #d4d4d4;
        }

        .btn-secondary:hover {
            background: #4e4e52;
        }

        .status-message {
            margin-top: 12px;
            padding: 8px 12px;
            border-radius: 3px;
            font-size: 13px;
            display: none;
        }

        .status-message.info {
            background: #1a3a52;
            color: #4fc3f7;
        }

        .status-message.success {
            background: #1e4620;
            color: #73c991;
        }

        .status-message.error {
            background: #5a1d1d;
            color: #f48771;
        }

        .status-message.active {
            display: block;
        }

        /* Custom Scrollbar Styles */
        .modal-content::-webkit-scrollbar {
            width: 10px;
        }

        .modal-content::-webkit-scrollbar-track {
            background: #1e1e1e;
        }

        .modal-content::-webkit-scrollbar-thumb {
            background: #3e3e42;
            border-radius: 0;
        }

        .modal-content::-webkit-scrollbar-thumb:hover {
            background: #4e4e52;
        }

        /* Firefox scrollbar */
        .modal-content {
            scrollbar-width: thin;
            scrollbar-color: #3e3e42 #1e1e1e;
        }

        /* General scrollbar for other elements */
        *::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }

        *::-webkit-scrollbar-track {
            background: #1e1e1e;
        }

        *::-webkit-scrollbar-thumb {
            background: #3e3e42;
            border-radius: 0;
        }

        *::-webkit-scrollbar-thumb:hover {
            background: #4e4e52;
        }

        /* Spinner Animation */
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .spinner {
            display: inline-block;
            width: 14px;
            height: 14px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top-color: #ffffff;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        .btn-primary .spinner {
            margin-right: 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="tabs">
            <div class="tabs-left">
                <button class="tab active" data-tab="source">Source</button>
                <button class="tab" data-tab="render">Render</button>
            </div>
            <div class="tabs-right">
                <button class="persist-btn" onclick="openPersistDialog()">
                    <svg viewBox="0 0 16 16" fill="currentColor">
                        <path d="M13.854 3.646a.5.5 0 0 1 0 .708l-7 7a.5.5 0 0 1-.708 0l-3.5-3.5a.5.5 0 1 1 .708-.708L6.5 10.293l6.646-6.647a.5.5 0 0 1 .708 0z"/>
                    </svg>
                    Persist
                </button>
            </div>
        </div>
        <div class="content">
            <div id="editor-container"></div>
            <div id="render-container">
                <iframe id="render-frame"></iframe>
            </div>
        </div>
    </div>

    <!-- Persist Dialog Modal -->
    <div class="modal-overlay" id="persistModal">
        <div class="modal">
            <div class="modal-header">
                <h2>Persist Project</h2>
                <button class="modal-close" onclick="closePersistDialog()">&times;</button>
            </div>
            <div class="modal-content">
                <div class="checklist">
                    <!-- Project Name Item -->
                    <div class="checklist-item">
                        <div class="checklist-item-header">
                            <span class="checklist-item-title">Project Name</span>
                            <span class="checklist-status pending" id="projectNameStatus">
                                <span id="projectNameStatusText">Required</span>
                            </span>
                        </div>
                        <div class="checklist-item-content">
                            <input 
                                type="text" 
                                id="projectNameInput" 
                                placeholder="Enter project name (e.g., my-project)"
                                oninput="validateProjectName()"
                            />
                        </div>
                    </div>

                    <!-- GitHub Login Item -->
                    <div class="checklist-item">
                        <div class="checklist-item-header">
                            <span class="checklist-item-title">GitHub Login</span>
                            <span class="checklist-status pending" id="githubStatus">
                                <span id="githubStatusText">Not logged in</span>
                            </span>
                        </div>
                        <div class="checklist-item-content" id="githubContent">
                            <button onclick="loginWithGitHub()">Login with GitHub</button>
                        </div>
                    </div>

                    <!-- Repository Link Item -->
                    <div class="checklist-item">
                        <div class="checklist-item-header">
                            <span class="checklist-item-title">Repository</span>
                            <span class="checklist-status ok">
                                <span>✓</span>
                            </span>
                        </div>
                        <div class="checklist-item-content">
                            <a href="https://github.com/cppxaxa/leetcoach-web" target="_blank" class="repo-link">
                                https://github.com/cppxaxa/leetcoach-web
                            </a>
                        </div>
                    </div>

                    <!-- Branch Name Item -->
                    <div class="checklist-item">
                        <div class="checklist-item-header">
                            <span class="checklist-item-title">Branch Name</span>
                            <span class="checklist-status ok" id="branchStatus">
                                <span id="branchStatusText">✓</span>
                            </span>
                        </div>
                        <div class="checklist-item-content">
                            <input 
                                type="text" 
                                id="branchNameInput" 
                                placeholder="users/{username}/timestamp-random"
                                oninput="validateBranchName()"
                            />
                        </div>
                    </div>

                    <!-- Pull Request Title Item -->
                    <div class="checklist-item">
                        <div class="checklist-item-header">
                            <span class="checklist-item-title">Pull Request Title</span>
                            <span class="checklist-status ok">
                                <span>✓</span>
                            </span>
                        </div>
                        <div class="checklist-item-content">
                            <div class="readonly-text" id="prTitleText">[DryRun] </div>
                        </div>
                    </div>
                </div>

                <div id="statusMessage" class="status-message"></div>
            </div>

            <div class="modal-footer">
                <button class="btn-secondary" onclick="closePersistDialog()">Cancel</button>
                <button class="btn-primary" id="raisePRBtn" onclick="raisePullRequest()">Raise PR</button>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.45.0/min/vs/loader.min.js"></script>
    <script>
        // ============================================
        // SUPABASE CONFIGURATION (from login.html)
        // ============================================
        const SUPABASE_URL = 'https://gmsijcphuvpfmprjxsbs.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imdtc2lqY3BodXZwZm1wcmp4c2JzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIwNzMzNTgsImV4cCI6MjA3NzY0OTM1OH0.0p1zuMeJvpQO2JFyR5IpDSyUJBgf0vaxUprWDlzlGfU';
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        let accessToken = null;
        let userData = null;

        // ============================================
        // GITHUB AUTHENTICATION
        // ============================================
        
        // Check for existing session on page load
        window.addEventListener('DOMContentLoaded', async () => {
            const { data: { session } } = await supabase.auth.getSession();
            
            if (session && session.provider_token) {
                accessToken = session.provider_token;
                await initializeGitHubUser();
            }
        });

        // Listen for auth state changes
        supabase.auth.onAuthStateChange(async (event, session) => {
            if (event === 'SIGNED_IN' && session && session.provider_token) {
                accessToken = session.provider_token;
                await initializeGitHubUser();
            } else if (event === 'SIGNED_OUT') {
                accessToken = null;
                userData = null;
                updateGitHubStatus(false);
            }
        });

        async function loginWithGitHub() {
            const { data, error } = await supabase.auth.signInWithOAuth({
                provider: 'github',
                options: {
                    scopes: 'public_repo',
                    redirectTo: window.location.href
                }
            });
            
            if (error) {
                console.error('GitHub login error:', error);
                alert('Error logging in with GitHub: ' + error.message);
            }
        }

        async function initializeGitHubUser() {
            try {
                const response = await fetch('https://api.github.com/user', {
                    headers: {
                        'Authorization': `token ${accessToken}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                
                if (!response.ok) throw new Error('Failed to fetch user data');
                
                userData = await response.json();
                updateGitHubStatus(true);
                
            } catch (error) {
                console.error('Error fetching GitHub user:', error);
                updateGitHubStatus(false);
            }
        }

        function updateGitHubStatus(isLoggedIn) {
            const statusEl = document.getElementById('githubStatus');
            const statusTextEl = document.getElementById('githubStatusText');
            const contentEl = document.getElementById('githubContent');
            
            if (isLoggedIn && userData) {
                statusEl.className = 'checklist-status ok';
                statusTextEl.textContent = '✓ Logged in';
                contentEl.innerHTML = `
                    <div class="user-info-compact">
                        <img src="${userData.avatar_url}" alt="${userData.login}">
                        <span>@${userData.login}</span>
                    </div>
                `;
            } else {
                statusEl.className = 'checklist-status pending';
                statusTextEl.textContent = 'Not logged in';
                contentEl.innerHTML = '<button onclick="loginWithGitHub()">Login with GitHub</button>';
            }
        }

        // ============================================
        // PROJECT NAME VALIDATION
        // ============================================
        
        function validateProjectName() {
            const input = document.getElementById('projectNameInput');
            const statusEl = document.getElementById('projectNameStatus');
            const statusTextEl = document.getElementById('projectNameStatusText');
            const value = input.value.trim();
            
            if (value.length === 0) {
                statusEl.className = 'checklist-status pending';
                statusTextEl.textContent = 'Required';
                // Remove projectname from URL if empty
                updateURLParameter('projectname', null);
            } else if (!/^[a-z0-9-]+$/.test(value)) {
                statusEl.className = 'checklist-status error';
                statusTextEl.textContent = '✗ Invalid (use a-z, 0-9, -)';
                updateURLParameter('projectname', value);
            } else {
                statusEl.className = 'checklist-status ok';
                statusTextEl.textContent = '✓ Valid';
                updateURLParameter('projectname', value);
            }
            
            // Update PR title
            updatePRTitle();
        }

        function validateBranchName() {
            const input = document.getElementById('branchNameInput');
            const statusEl = document.getElementById('branchStatus');
            const statusTextEl = document.getElementById('branchStatusText');
            const value = input.value.trim();
            
            if (value.length === 0) {
                statusEl.className = 'checklist-status pending';
                statusTextEl.textContent = 'Required';
            } else if (!/^[a-zA-Z0-9/_-]+$/.test(value)) {
                statusEl.className = 'checklist-status error';
                statusTextEl.textContent = '✗ Invalid';
            } else {
                statusEl.className = 'checklist-status ok';
                statusTextEl.textContent = '✓ Valid';
            }
        }

        function updatePRTitle() {
            const projectName = document.getElementById('projectNameInput').value.trim();
            const prTitleEl = document.getElementById('prTitleText');
            prTitleEl.textContent = `[DryRun] ${projectName || ''}`;
        }

        function updateURLParameter(key, value) {
            const url = new URL(window.location);
            
            if (value === null || value === '') {
                url.searchParams.delete(key);
            } else {
                url.searchParams.set(key, value);
            }
            
            // Update URL without reloading the page
            window.history.replaceState({}, '', url);
        }

        function generateBranchName() {
            if (!userData) return '';
            
            const timestamp = Date.now();
            const randomStr = Math.random().toString(36).substring(2, 8);
            const randomText = `${timestamp}-${randomStr}`;
            
            return `users/${userData.login}/${randomText}`;
        }

        // ============================================
        // LIBRARY.JS VALIDATOR
        // ============================================
        
        function validateLibraryJS(originalContent, modifiedContent) {
            const errors = [];
            
            // 1. Syntax validation - check if it's valid JavaScript
            try {
                // Create a safe evaluation context
                const testFunc = new Function(modifiedContent + '; return window.problemLibrary;');
                const problemLibrary = testFunc();
                
                // 2. Structure validation - ensure problemLibrary exists and is an object
                if (!problemLibrary || typeof problemLibrary !== 'object') {
                    errors.push('Invalid structure: window.problemLibrary must be an object');
                    return { valid: false, errors };
                }
                
                // 3. Validate hierarchical structure (should have categories with nested problems)
                const categories = Object.keys(problemLibrary);
                if (categories.length === 0) {
                    errors.push('Invalid structure: problemLibrary must contain at least one category');
                    return { valid: false, errors };
                }
                
                // Check each category is an object
                for (const category of categories) {
                    if (typeof problemLibrary[category] !== 'object' || problemLibrary[category] === null) {
                        errors.push(`Invalid structure: Category "${category}" must be an object`);
                    }
                }
                
            } catch (e) {
                errors.push(`Syntax error: ${e.message}`);
                return { valid: false, errors };
            }
            
            // 4. Check for deletions - ensure no content was removed
            if (originalContent && originalContent.trim().length > 0) {
                try {
                    // Extract all problem names from original
                    const originalFunc = new Function(originalContent + '; return window.problemLibrary;');
                    const originalLibrary = originalFunc();
                    
                    const modifiedFunc = new Function(modifiedContent + '; return window.problemLibrary;');
                    const modifiedLibrary = modifiedFunc();
                    
                    // Check that all original entries still exist
                    const originalEntries = extractAllEntries(originalLibrary);
                    const modifiedEntries = extractAllEntries(modifiedLibrary);
                    
                    // Remove stars for comparison (stars can be added to keys)
                    const normalizeKey = (key) => key.replace(/\s*⭐\s*/g, '').trim();
                    
                    // Build a map of normalized keys to their values for both original and modified
                    const originalMap = new Map();
                    originalEntries.forEach(e => {
                        originalMap.set(normalizeKey(e.key), e.value);
                    });
                    
                    const modifiedMap = new Map();
                    modifiedEntries.forEach(e => {
                        modifiedMap.set(normalizeKey(e.key), e.value);
                    });
                    
                    // Check for deletions
                    const deletedKeys = [];
                    for (const [key, value] of originalMap.entries()) {
                        if (!modifiedMap.has(key)) {
                            deletedKeys.push(key);
                        }
                    }
                    
                    if (deletedKeys.length > 0) {
                        errors.push(`Deletions detected: The following entries were removed: ${deletedKeys.join(', ')}`);
                        return { valid: false, errors };
                    }
                    
                    // Check that problem descriptions (values) weren't modified
                    // Only check existing problems, not new ones
                    for (const [key, originalValue] of originalMap.entries()) {
                        const modifiedValue = modifiedMap.get(key);
                        
                        if (modifiedValue && modifiedValue !== originalValue) {
                            errors.push(`Content modification detected: Problem "${key}" description has been changed`);
                        }
                    }
                    
                } catch (e) {
                    errors.push(`Error checking for deletions: ${e.message}`);
                    return { valid: false, errors };
                }
            }
            
            if (errors.length > 0) {
                return { valid: false, errors };
            }
            
            return { valid: true, errors: [] };
        }
        
        // Helper function to extract all entries from problemLibrary recursively
        function extractAllEntries(obj, path = []) {
            const entries = [];
            
            for (const key in obj) {
                if (obj.hasOwnProperty(key)) {
                    const value = obj[key];
                    const currentPath = [...path, key];
                    
                    if (typeof value === 'object' && value !== null && !Array.isArray(value)) {
                        // It's a nested category, recurse
                        entries.push(...extractAllEntries(value, currentPath));
                    } else if (typeof value === 'string') {
                        // It's a problem entry
                        entries.push({
                            key: key,
                            path: currentPath,
                            value: value
                        });
                    }
                }
            }
            
            return entries;
        }
        
        // ============================================
        // PULL REQUEST FUNCTIONALITY
        // ============================================
        
        const REPO_OWNER = 'cppxaxa';
        const REPO_NAME = 'leetcoach-web';
        const REPO_FULL_NAME = `${REPO_OWNER}/${REPO_NAME}`;

        async function raisePullRequest() {
            // Validate all required fields
            const projectName = document.getElementById('projectNameInput').value.trim();
            const branchName = document.getElementById('branchNameInput').value.trim();
            
            if (!projectName || !/^[a-z0-9-]+$/.test(projectName)) {
                showStatusMessage('Please enter a valid project name', 'error');
                return;
            }
            
            if (!userData || !accessToken) {
                showStatusMessage('Please log in with GitHub first', 'error');
                return;
            }
            
            if (!branchName) {
                showStatusMessage('Please enter a branch name', 'error');
                return;
            }
            
            if (!editor) {
                showStatusMessage('Editor not initialized', 'error');
                return;
            }
            
            const btn = document.getElementById('raisePRBtn');
            btn.disabled = true;
            const originalContent = btn.innerHTML;
            btn.innerHTML = '<span class="spinner"></span>';
            
            try {
                // 1. Get the default branch's latest commit SHA
                showStatusMessage('Getting repository information...', 'info');
                const repoResponse = await fetch(`https://api.github.com/repos/${REPO_FULL_NAME}`, {
                    headers: {
                        'Authorization': `token ${accessToken}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                const repoData = await repoResponse.json();
                const defaultBranch = repoData.default_branch;
                
                // 2. Get the default branch reference
                const refResponse = await fetch(`https://api.github.com/repos/${REPO_FULL_NAME}/git/ref/heads/${defaultBranch}`, {
                    headers: {
                        'Authorization': `token ${accessToken}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                const refData = await refResponse.json();
                const baseSha = refData.object.sha;
                
                // 3. Create new branch
                showStatusMessage('Creating new branch...', 'info');
                await fetch(`https://api.github.com/repos/${REPO_FULL_NAME}/git/refs`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `token ${accessToken}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        ref: `refs/heads/${branchName}`,
                        sha: baseSha
                    })
                });
                
                // 4. Check and update js/library.js
                showStatusMessage('Checking js/library.js...', 'info');
                let librarySha = null;
                let libraryContent = '';
                let needsUpdate = false;
                
                try {
                    const libraryResponse = await fetch(`https://api.github.com/repos/${REPO_FULL_NAME}/contents/js/library.js?ref=${branchName}`, {
                        headers: {
                            'Authorization': `token ${accessToken}`,
                            'Accept': 'application/vnd.github.v3+json'
                        }
                    });
                    
                    if (libraryResponse.ok) {
                        const libraryData = await libraryResponse.json();
                        librarySha = libraryData.sha;
                        libraryContent = decodeURIComponent(escape(atob(libraryData.content)));
                        
                        // Convert project name: "two-sum" -> "Two Sum"
                        // Replace hyphens with spaces and capitalize first letter of each word
                        const searchProjectName = projectName
                            .split('-')
                            .map(word => word.charAt(0).toUpperCase() + word.slice(1))
                            .join(' ');
                        
                        console.log(`Searching for project: "${searchProjectName}" (from "${projectName}")`);
                        
                        // Escape special regex characters
                        const escapedProjectName = searchProjectName.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                        
                        // Check if project exists without a star (case-insensitive)
                        const hasProjectWithoutStar = new RegExp(`["'\`]${escapedProjectName}(?!\\s*⭐)["'\`]`, 'gi').test(libraryContent);
                        
                        if (hasProjectWithoutStar) {
                            needsUpdate = true;
                            // Add star inside the quotes before the closing quote
                            libraryContent = libraryContent.replace(
                                new RegExp(`(["'\`]${escapedProjectName})(["'\`])`, 'gi'),
                                `$1 ⭐$2`
                            );
                            
                            console.log('Project found without star, adding star');
                        } else {
                            console.log('Project either already has star or not found in library.js');
                        }
                    }
                } catch (e) {
                    console.log('js/library.js does not exist or error reading it:', e);
                }
                
                // 5. Update js/library.js if needed
                if (needsUpdate && librarySha) {
                    showStatusMessage('Validating js/library.js changes...', 'info');
                    
                    // Get original content for comparison
                    const originalLibraryResponse = await fetch(`https://api.github.com/repos/${REPO_FULL_NAME}/contents/js/library.js?ref=${defaultBranch}`, {
                        headers: {
                            'Authorization': `token ${accessToken}`,
                            'Accept': 'application/vnd.github.v3+json'
                        }
                    });
                    
                    let originalLibraryContent = '';
                    if (originalLibraryResponse.ok) {
                        const originalLibraryData = await originalLibraryResponse.json();
                        originalLibraryContent = decodeURIComponent(escape(atob(originalLibraryData.content)));
                    }
                    
                    // Validate the changes
                    const validationResult = validateLibraryJS(originalLibraryContent, libraryContent);
                    
                    if (!validationResult.valid) {
                        const errorMessage = '❌ library.js validation failed:\n' + validationResult.errors.map(e => '  • ' + e).join('\n');
                        showStatusMessage(errorMessage, 'error');
                        console.error('Validation errors:', validationResult.errors);
                        throw new Error('library.js validation failed: ' + validationResult.errors.join('; '));
                    }
                    
                    console.log('✓ library.js validation passed');
                    
                    showStatusMessage('Updating js/library.js...', 'info');
                    const updateResponse = await fetch(`https://api.github.com/repos/${REPO_FULL_NAME}/contents/js/library.js`, {
                        method: 'PUT',
                        headers: {
                            'Authorization': `token ${accessToken}`,
                            'Accept': 'application/vnd.github.v3+json',
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            message: `Add star to ${projectName} in library.js`,
                            content: btoa(unescape(encodeURIComponent(libraryContent))),
                            sha: librarySha,
                            branch: branchName
                        })
                    });
                    
                    if (!updateResponse.ok) {
                        const errorData = await updateResponse.json();
                        console.error('Failed to update library.js:', errorData);
                        throw new Error('Failed to update library.js: ' + (errorData.message || 'Unknown error'));
                    }
                    
                    console.log('library.js updated successfully');
                }
                
                // 6. Create or update projects/{project-name}/dryrun.html
                showStatusMessage('Creating dryrun.html...', 'info');
                const dryrunPath = `projects/${projectName}/dryrun.html`;
                const htmlContent = editor.getValue();
                
                let dryrunSha = null;
                try {
                    const dryrunResponse = await fetch(`https://api.github.com/repos/${REPO_FULL_NAME}/contents/${dryrunPath}?ref=${defaultBranch}`, {
                        headers: {
                            'Authorization': `token ${accessToken}`,
                            'Accept': 'application/vnd.github.v3+json'
                        }
                    });
                    if (dryrunResponse.ok) {
                        const dryrunData = await dryrunResponse.json();
                        dryrunSha = dryrunData.sha;
                    }
                } catch (e) {
                    // File doesn't exist, will create new
                }
                
                const dryrunUpdateData = {
                    message: `Add/update dryrun.html for ${projectName}`,
                    content: btoa(unescape(encodeURIComponent(htmlContent))),
                    branch: branchName
                };
                
                if (dryrunSha) {
                    dryrunUpdateData.sha = dryrunSha;
                }
                
                await fetch(`https://api.github.com/repos/${REPO_FULL_NAME}/contents/${dryrunPath}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${accessToken}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(dryrunUpdateData)
                });
                
                // 7. Create pull request
                showStatusMessage('Creating pull request...', 'info');
                const prTitle = `[DryRun] ${projectName}`;
                const prBody = `This PR adds the dryrun.html file for the project: ${projectName}`;
                
                const prResponse = await fetch(`https://api.github.com/repos/${REPO_FULL_NAME}/pulls`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `token ${accessToken}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        title: prTitle,
                        body: prBody,
                        head: branchName,
                        base: defaultBranch
                    })
                });
                
                const prData = await prResponse.json();
                
                if (prResponse.ok) {
                    showStatusMessage(
                        `✅ Success! Pull request created: <a href="${prData.html_url}" target="_blank" style="color: #73c991; text-decoration: underline;">#${prData.number}</a>`,
                        'success'
                    );
                } else {
                    throw new Error(prData.message || 'Failed to create pull request');
                }
                
            } catch (error) {
                showStatusMessage('❌ Error: ' + error.message, 'error');
                console.error(error);
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalContent;
            }
        }

        function showStatusMessage(message, type) {
            const statusDiv = document.getElementById('statusMessage');
            if (!message) {
                statusDiv.className = 'status-message';
                statusDiv.innerHTML = '';
                return;
            }
            statusDiv.className = `status-message ${type} active`;
            statusDiv.innerHTML = message;
        }

        // ============================================
        // PERSIST DIALOG FUNCTIONS
        // ============================================
        
        function openPersistDialog() {
            // Populate project name from URL if present
            const urlParams = new URLSearchParams(window.location.search);
            const projectName = urlParams.get('projectname');
            
            if (projectName) {
                document.getElementById('projectNameInput').value = projectName;
                validateProjectName();
            }
            
            // Generate and populate branch name if user is logged in
            if (userData) {
                document.getElementById('branchNameInput').value = generateBranchName();
                validateBranchName();
            }
            
            // Update GitHub status
            updateGitHubStatus(userData !== null);
            
            // Update PR title
            updatePRTitle();
            
            // Clear status message
            showStatusMessage('', '');
            
            // Show modal
            document.getElementById('persistModal').classList.add('active');
        }

        function closePersistDialog() {
            document.getElementById('persistModal').classList.remove('active');
        }

        // Close modal on overlay click
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('persistModal').addEventListener('click', (e) => {
                if (e.target.id === 'persistModal') {
                    closePersistDialog();
                }
            });
        });

        // ============================================
        // MONACO EDITOR SETUP
        // ============================================
        
        let editor;
        let currentTab = 'source';

        // Initialize Monaco Editor
        require.config({ paths: { vs: 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.45.0/min/vs' } });
        
        require(['vs/editor/editor.main'], function () {
            const defaultContent = '';

            editor = monaco.editor.create(document.getElementById('editor-container'), {
                value: defaultContent,
                language: 'html',
                theme: 'vs-dark',
                automaticLayout: true,
                minimap: {
                    enabled: true
                },
                fontSize: 14,
                lineNumbers: 'on',
                scrollBeyondLastLine: false,
                wordWrap: 'on'
            });

            // Check for projectname query parameter and load project file
            const urlParams = new URLSearchParams(window.location.search);
            const projectName = urlParams.get('projectname');
            
            if (projectName) {
                const projectPath = `projects/${projectName}/dryrun.html`;
                const projectUrl = `${window.location.origin}${window.location.pathname.substring(0, window.location.pathname.lastIndexOf('/'))}/${projectPath}`;
                
                fetch(projectUrl)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        return response.text();
                    })
                    .then(content => {
                        editor.setValue(content);
                    })
                    .catch(error => {
                        console.error('Failed to load project file:', error);
                        // Keep editor empty on failure
                        editor.setValue('');
                    });
            }
        });

        // Tab switching functionality
        const tabs = document.querySelectorAll('.tab');
        const editorContainer = document.getElementById('editor-container');
        const renderContainer = document.getElementById('render-container');
        const renderFrame = document.getElementById('render-frame');

        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                const tabName = tab.dataset.tab;
                switchTab(tabName);
            });
        });

        function switchTab(tabName) {
            // Update active tab
            tabs.forEach(t => t.classList.remove('active'));
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');

            currentTab = tabName;

            if (tabName === 'source') {
                editorContainer.style.display = 'block';
                renderContainer.style.display = 'none';
            } else if (tabName === 'render') {
                editorContainer.style.display = 'none';
                renderContainer.style.display = 'block';
                renderHTML();
            }
        }

        function renderHTML() {
            if (!editor) return;
            
            const htmlContent = editor.getValue();
            const blob = new Blob([htmlContent], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            
            renderFrame.src = url;
            
            // Clean up the old URL when frame loads
            renderFrame.onload = () => {
                URL.revokeObjectURL(url);
            };
        }

        // Keyboard shortcut: Ctrl+Enter to switch to render
        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey && e.key === 'Enter') {
                e.preventDefault();
                switchTab('render');
            }
        });
    </script>
</body>
</html>
